# 音效系统使用说明

## 概述

游戏已集成完整的音效系统，包括：
- ✅ **玩家攻击音效** - 每次玩家发射投射物时播放
- ✅ **敌人攻击音效** - 敌人远程攻击时播放
- ✅ **投射物命中音效** - 玩家投射物击中敌人时播放
- ✅ **爆炸音效** - 爆炸伤害触发时播放（距离衰减）
- ✅ **敌人死亡音效** - 敌人被击杀时播放
- ✅ **玩家受击音效** - 玩家受到伤害时播放（接触/远程/爆炸）
- ✅ **升级音效** - 进入下一层时播放
- ✅ **UI点击音效** - 选择被动属性时播放
- ✅ **背景音乐** - 游戏开始时自动播放（支持淡入淡出）

## 技术实现

### 音频系统特点

1. **程序化生成音效**：
   - 使用 Web Audio API 动态生成音效
   - 无需外部音频文件即可工作
   - 支持音量、音调调整

2. **支持外部音频文件**（可选）：
   - 如果需要更高质量的音效，可以加载外部音频文件
   - 支持 MP3、OGG 等格式

3. **智能音量管理**：
   - 独立的主音量、音效音量、背景音乐音量控制
   - 爆炸音效支持距离衰减（越远声音越小）

4. **暂停/恢复**：
   - 游戏暂停时自动暂停背景音乐
   - 游戏继续时自动恢复

## 已添加的音效事件

### 1. 玩家攻击 (`player_attack`)
- **触发时机**：每次玩家发射投射物
- **特性**：
  - 暴击时音量更大（×1.2）、音调更高（×1.3）
  - 基础音效：短促的"啾"声（800Hz → 400Hz）

### 2. 敌人远程攻击 (`enemy_attack`)
- **触发时机**：敌人发射远程投射物
- **特性**：
  - 狙击手使用更低的音调（×0.8）
  - 基础音效：低沉的"砰"声（200Hz → 100Hz）

### 3. 投射物命中 (`projectile_hit`)
- **触发时机**：玩家投射物击中敌人
- **特性**：
  - 暴击时音量更大、音调更高
  - 基础音效：尖锐的"叮"声（600Hz → 300Hz）

### 4. 爆炸 (`explosion`)
- **触发时机**：爆炸伤害触发时
- **特性**：
  - 支持距离衰减（距离越远音量越小）
  - 只在2倍爆炸半径内播放（避免过远的声音）
  - 基础音效：低沉的"轰"声（150Hz → 50Hz）

### 5. 敌人死亡 (`enemy_death`)
- **触发时机**：敌人被击杀
- **特性**：
  - 基础音效：下落的音调（400Hz → 100Hz）

### 6. 玩家受击 (`player_hit`)
- **触发时机**：玩家受到任何伤害（接触/远程/爆炸）
- **特性**：
  - 不同伤害类型使用不同音量
  - 爆炸伤害支持距离衰减
  - 基础音效：短促的"啪"声（300Hz → 150Hz）

### 7. 升级 (`level_up`)
- **触发时机**：进入下一层时
- **特性**：
  - 基础音效：上升的音调（200Hz → 600Hz）

### 8. UI点击 (`ui_click`)
- **触发时机**：选择被动属性时
- **特性**：
  - 基础音效：轻微的"咔"声（800Hz → 400Hz）

### 9. 背景音乐 (`background_music`)
- **触发时机**：游戏开始时自动播放
- **特性**：
  - 自动循环播放
  - 支持淡入淡出效果
  - 暂停游戏时自动暂停，继续时自动恢复

## 如何添加自定义音频文件

如果你想使用自己的音频文件替代程序化生成的音效：

### 方法1：在游戏引擎外部加载（推荐）

在游戏开始前，加载音频文件：

```typescript
// 在 GameView.vue 或类似位置
import { AudioSystem } from '@/game/systems/AudioSystem'

const audioSystem = new AudioSystem()

// 加载背景音乐
await audioSystem.loadBackgroundMusic('/path/to/background-music.mp3', true)

// 加载音效
await audioSystem.loadSoundEffect('player_attack', '/path/to/attack-sound.mp3')
await audioSystem.loadSoundEffect('explosion', '/path/to/explosion-sound.mp3')
// ... 其他音效
```

### 方法2：在 TestGameEngine 构造函数中加载

修改 `TestGameEngine.ts` 的构造函数：

```typescript
constructor(canvas: HTMLCanvasElement, onLevelComplete?: () => void, gameState?: any) {
  // ... 现有代码 ...
  
  // 初始化音频系统
  this.audioSystem = new AudioSystem()
  
  // 加载音频文件（可选）
  this.audioSystem.loadBackgroundMusic('/assets/audio/bg-music.mp3', true).catch(e => {
    console.log('背景音乐文件未找到，使用程序化生成')
  })
  
  this.audioSystem.loadSoundEffect('player_attack', '/assets/audio/attack.mp3').catch(() => {})
  this.audioSystem.loadSoundEffect('explosion', '/assets/audio/explosion.mp3').catch(() => {})
  // ... 其他音效
}
```

### 音频文件推荐

建议的音频文件结构：

```
public/
  audio/
    bg-music.mp3          # 背景音乐（推荐：循环播放，时长 2-5 分钟）
    player-attack.mp3     # 玩家攻击（推荐：短促，< 0.5 秒）
    enemy-attack.mp3       # 敌人攻击（推荐：低音，< 0.5 秒）
    projectile-hit.mp3     # 投射物命中（推荐：清脆，< 0.3 秒）
    explosion.mp3          # 爆炸（推荐：低沉，< 0.5 秒）
    enemy-death.mp3        # 敌人死亡（推荐：短促，< 0.5 秒）
    player-hit.mp3         # 玩家受击（推荐：短促，< 0.3 秒）
    level-up.mp3           # 升级（推荐：上升音调，< 1 秒）
    ui-click.mp3           # UI点击（推荐：轻微，< 0.2 秒）
```

## 音量控制

### 在代码中调整音量

```typescript
// 在 TestGameEngine 构造函数或初始化时
this.audioSystem.setMasterVolume(0.7)        // 主音量（0-1）
this.audioSystem.setSoundEffectsVolume(0.8) // 音效音量（0-1）
this.audioSystem.setMusicVolume(0.4)        // 背景音乐音量（0-1）
```

### 静音/取消静音

```typescript
this.audioSystem.setMuted(true)   // 静音
this.audioSystem.setMuted(false)  // 取消静音
```

## 性能优化

1. **音效复用**：相同的音效可以同时播放多个实例（例如多个爆炸同时发生）
2. **距离衰减**：爆炸音效只在一定范围内播放，避免过多的音频处理
3. **静音时跳过**：静音时不会执行音效生成/播放逻辑

## 浏览器兼容性

- ✅ 支持所有现代浏览器（Chrome, Firefox, Safari, Edge）
- ✅ 使用 Web Audio API（需要用户交互后才能播放）
- ✅ 如果没有 Web Audio API，会回退到静默模式

## 注意事项

1. **用户交互要求**：浏览器通常要求用户先与页面交互后才能播放音频。确保游戏开始时有一个点击事件。

2. **自动播放策略**：部分浏览器（如 Safari）可能阻止自动播放音频，需要用户先点击页面。

3. **背景音乐音量**：默认背景音乐音量设置为 0.4（40%），以免掩盖音效。可根据需要调整。

4. **程序化音效限制**：程序化生成的音效相对简单。如需更丰富的音效，建议使用真实的音频文件。

## 调试

如果音效没有播放，检查：

1. 浏览器控制台是否有错误信息
2. 浏览器是否允许自动播放音频（可能需要用户交互）
3. 音量设置是否过低或被静音
4. Web Audio API 是否可用：`console.log(new AudioContext())`

## 未来改进建议

1. **音效池系统**：预加载和复用音频对象，提高性能
2. **3D 音频定位**：根据声音源位置调整左右声道（需要 Web Audio API 的 PannerNode）
3. **音频资源管理**：统一管理所有音频文件的加载和卸载
4. **音量设置界面**：在游戏UI中添加音量滑块

